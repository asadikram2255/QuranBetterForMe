<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Qur’an Search — Hybrid IR (BM25 + Embeddings)</title>
<style>
  :root{
    --bg:#0f172a; --fg:#e5e7eb; --card:#111827; --border:#1f2937;
    --muted:#94a3b8; --link:#93c5fd; --chip:#334155; --okbg:#052e1a; --okfg:#86efac;
    --warnbg:#3f1d1d; --warnfg:#fecaca;
  }
  html,body{margin:0;height:100%;background:var(--bg);color:var(--fg);font:15px system-ui,Segoe UI,Roboto,Arial}
  .wrap{max-width:1100px;margin:22px auto;padding:0 14px}
  .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
  .card{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:12px;margin-bottom:12px}
  .btn,.input,select{background:#0b1220;color:var(--fg);border:1px solid #273244;border-radius:8px;padding:8px 10px}
  .btn{cursor:pointer}
  .col2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  .list{height:58vh;overflow:auto;border-radius:8px}
  .item{padding:10px;border-bottom:1px solid #1e293b}
  .item:hover{background:#0b1220}
  .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace}
  .muted{color:var(--muted)}
  .eng{color:#cbd5e1;margin-top:6px}
  label.small{font-size:12px;color:#cbd5e1}
  .chip{padding:4px 8px;border:1px solid var(--chip);border-radius:999px;font-size:12px}
  .ok{background:var(--okbg);border-color:#14532d;color:var(--okfg)}
  .warn{background:var(--warnbg);border-color:#7f1d1d;color:var(--warnfg)}
  .link{color:var(--link);text-decoration:none}
  .err{background:var(--warnbg);border:1px solid #7f1d1d;color:var(--warnfg);padding:8px;border-radius:8px;margin-top:8px}
  .sub{font-size:12px;color:var(--muted)}
  .meter{height:6px;background:#0b1220;border:1px solid #273244;border-radius:6px;overflow:hidden;margin-top:4px}
  .meter>div{height:100%}
  .bar-hybrid{background:#60a5fa}
  .bar-cos{background:#22d3ee}
  .bar-bm25{background:#a78bfa}
  .pill{font-size:12px;border:1px solid #2b3a50;border-radius:999px;padding:2px 8px}
  .badge{display:inline-block;margin-left:.5rem;padding:.05rem .35rem;background:#eef;color:#334;border:1px solid #ccd;border-radius:6px;font-size:.75rem}
</style>
</head>
<body>
<div class="wrap">
  <h2>Qur’an Better For Me <span class="muted">— A Semantic, Lexical and Hybrid Search System</span></h2>

  <!-- STATUS + METHOD -->
  <div class="card">
    <div class="row">
      <div>
        <label class="small">Method</label>
        <select id="method">
          <option value="hybrid">Hybrid (α·cos + (1−α)·BM25)</option>
          <option value="cos">Cosine-only</option>
          <option value="bm25">BM25-only</option>
        </select>
      </div>
      <button class="btn" id="exportJson">Export current neighbors (JSON)</button>
      <button class="btn" id="exportCsv">Export current neighbors (CSV)</button>
    </div>
    <div class="row" style="margin-top:6px">
      <span id="st_links_h" class="chip warn">links (hybrid): not loaded</span>
      <span id="st_links_c" class="chip warn">links (cosine): not loaded</span>
      <span id="st_links_b" class="chip warn">links (bm25): not loaded</span>
      <span id="st_ar" class="chip warn">arabic: not loaded</span>
      <span id="st_en" class="chip warn">english: not loaded</span>
      <span class="muted">Autoloading from <code>/json/</code> and <code>/Database/</code> (via raw.githubusercontent.com)</span>
    </div>
    <div class="row" style="margin-top:6px">
      <span id="metaInfo" class="sub">α≈0.8, K=20 (display)</span>
    </div>
    <div id="errors"></div>
  </div>

  <!-- SEARCH -->
  <div class="card">
    <div class="row">
      <div style="flex:1;min-width:260px">
        <label class="small">Arabic keyword</label>
        <div class="row">
          <input id="q_ar" class="input" placeholder="اكتب كلمة عربية" style="flex:1"/>
          <button class="btn" onclick="searchByArabic()">Search</button>
        </div>
      </div>
      <div style="flex:1;min-width:260px">
        <label class="small">English keyword</label>
        <div class="row">
          <input id="q_en" class="input" placeholder="Type English keyword" style="flex:1"/>
          <button class="btn" onclick="searchByEnglish()">Search</button>
        </div>
      </div>
      <div style="flex:0.7;min-width:220px">
        <label class="small">Ayah ID (e.g., 2:177)</label>
        <div class="row">
          <input id="q_id" class="input" placeholder="2:177" style="flex:1"/>
          <button class="btn" onclick="searchByID()">Open</button>
        </div>
      </div>
      <div><button class="btn" onclick="clearAll()">Clear All</button></div>
    </div>
  </div>

  <!-- RESULTS + NEIGHBORS -->
  <div class="col2">
    <div class="card">
      <b>Results</b>
      <div id="results" class="list"></div>
    </div>
    <div class="card">
      <div class="row" style="justify-content:space-between;align-items:center">
        <b>Neighbors for: <span id="currentKey" class="mono">—</span></b>
        <div class="row" style="gap:6px">
          <input id="nf" class="input" placeholder="Filter neighbors (Arabic/English/ID)" style="flex:1;min-width:240px"/>
          <label class="small" style="display:flex;align-items:center;gap:6px">Min Overlap
            <input id="minOv" type="number" step="0.05" min="0" max="1" value="0" class="input" style="width:80px"/>
          </label>
          <button class="btn" onclick="renderNeighbors(window.currentNeighbors)">Apply</button>
        </div>
      </div>
      <div id="neighbors" class="list"></div>
    </div>
  </div>

  <div class="card sub">
    <b>Notes</b> — Hybrid = α·cos + (1−α)·BM25 (per-query min–max; rank fallback on ties). Display shows normalized+raw values; “Min Overlap” filters by token overlap.
  </div>
</div>

<script>
(function(){
  // ====== YOUR REPO (absolute RAW URLs) ======
  const REPO = "asadikram2255/QuranBetterForMe";
  const RAW_BASE = "https://raw.githubusercontent.com/" + REPO + "/main/";

  // Data in /Database/
  const ARABIC_CSV_URLS = [
    RAW_BASE + "Database/quran.csv"
  ];
  const ENGLISH_CSV_URLS = [
    RAW_BASE + "Database/English%20Translation%20-%20The%20Quran%20Dataset.csv", // your file
    RAW_BASE + "Database/translation.csv"                                         // fallback if you rename later
  ];

  // Shards in /json/ named hybrid_001.json, cos_001.json, bm25_001.json
  function jsonShardUrl(mode, surah){
    return RAW_BASE + "json/" + `${mode}_${String(surah).padStart(3,'0')}.json`;
  }

  // ====== STATE ======
  let MODE = "hybrid";
  let VERSES_AR = new Map(), VERSES_EN = new Map();
  let ALL_KEYS = [];
  const SHARD_CACHE = { hybrid:{}, cos:{}, bm25:{} };
  window.currentNeighbors = [];

  // ====== DOM ======
  const elResults   = document.getElementById('results');
  const elNeighbors = document.getElementById('neighbors');
  const elCurrent   = document.getElementById('currentKey');
  const elErrors    = document.getElementById('errors');
  const stAR        = document.getElementById('st_ar');
  const stEN        = document.getElementById('st_en');
  const stLH        = document.getElementById('st_links_h');
  const stLC        = document.getElementById('st_links_c');
  const stLB        = document.getElementById('st_links_b');
  const elMethod    = document.getElementById('method');

  function setStatus(el, ok, label){ el.textContent = `${label} ${ok?'✓':'✕'}`; el.className = "chip " + (ok?'ok':'warn'); }
  function setResults(html){ elResults.innerHTML = html; }
  function setNeighbors(html){ elNeighbors.innerHTML = html; }
  function setCurrent(t){ elCurrent.textContent = t; }
  function showError(msg){ elErrors.innerHTML = `<div class="err">${msg}</div>`; console.error(msg); }
  function clearError(){ elErrors.innerHTML = ""; }

  // ====== HELPERS ======
  const diacritics=/[\u0610-\u061A\u064B-\u065F\u06D6-\u06ED]/g, tatweel=/\u0640/g;
  function normAR(s){ return (s||"").toString().replace(tatweel,"").replace(diacritics,"").replace(/إ|أ|آ/g,"ا").replace(/ؤ/g,"و").replace(/ئ|ى/g,"ي").replace(/ة/g,"ه").toLowerCase(); }
  const normEN = s => (s||"").toString().toLowerCase();
  const esc    = s => (s||"").replace(/&/g,"&amp;").replace(/</g,"&lt;");
  function splitCSVLine(line){
    let delim=','; const c1=(line.match(/,/g)||[]).length,c2=(line.match(/;/g)||[]).length,c3=(line.match(/\t/g)||[]).length;
    if(c2>c1 && c2>=c3) delim=';'; else if(c3>c1 && c3>c2) delim='\t';
    const out=[]; let cur='', inQ=false;
    for(let i=0;i<line.length;i++){
      const ch=line[i];
      if(ch==='"'){ if(inQ && line[i+1]==='"'){cur+='"'; i++;} else inQ=!inQ; }
      else if(ch===delim && !inQ){ out.push(cur); cur=''; }
      else cur+=ch;
    } out.push(cur); return out;
  }
  function cleanHeader(h){ return String(h||'').replace(/^\ufeff/,'').trim().toLowerCase(); }
  function findIndex(headers, list){ for(const n of list){ const i=headers.indexOf(n); if(i>-1) return i; } return -1; }
  function safeKey(s,a){
    const S=parseInt(String(s).replace(/\D+/g,''),10), A=parseInt(String(a).replace(/\D+/g,''),10);
    return (Number.isFinite(S)&&Number.isFinite(A)) ? `${S}:${A}` : null;
  }
  function surahOfKey(k){ const m=String(k).match(/^([1-9]\d*):/); return m?parseInt(m[1],10):null; }

  // ====== LOADERS ======
  async function fetchText(url){
    const r = await fetch(url, {cache:"force-cache"});
    if(!r.ok) throw new Error(`${r.status} ${r.statusText} → ${url}`);
    return r.text();
  }
  async function fetchJSON(url){
    const r = await fetch(url, {cache:"force-cache"});
    if(!r.ok) throw new Error(`${r.status} ${r.statusText} → ${url}`);
    return r.json();
  }
  async function tryFirstText(urls){
    for(const u of urls){
      try { const txt = await fetchText(u); return {url:u, text:txt}; } catch(e){ /* try next */ }
    }
    throw new Error("Could not load any of:\n" + urls.join("\n"));
  }

  async function loadArabicCSV(){
    const {url, text} = await tryFirstText(ARABIC_CSV_URLS);
    const lines = text.split(/\r?\n/).filter(Boolean);
    const header = splitCSVLine(lines[0]).map(cleanHeader);
    const iS=findIndex(header,['surah','surah_no','sura','chapter','chapter_no']);
    const iA=findIndex(header,['ayah','ayah_no','ayah_no_surah','verse','verse_no','aya']);
    const iT=findIndex(header,['arabic_text','ayah_ar','arabic','text_ar','text']);
    if(iS<0||iA<0||iT<0) throw new Error("Arabic CSV headers missing (need surah, ayah, arabic_text). Loaded from: " + url);
    VERSES_AR.clear();
    for(let i=1;i<lines.length;i++){
      const row=splitCSVLine(lines[i]); if(!row || row.length<=Math.max(iS,iA,iT)) continue;
      const k=safeKey(row[iS],row[iA]); if(!k) continue;
      VERSES_AR.set(k,row[iT]||'');
    }
    ALL_KEYS = Array.from(VERSES_AR.keys());
    setStatus(stAR,true,"arabic");
  }

  async function loadEnglishCSV(){
    try{
      const {text} = await tryFirstText(ENGLISH_CSV_URLS);
      const lines = text.split(/\r?\n/).filter(Boolean);
      const header = splitCSVLine(lines[0]).map(cleanHeader);
      const iS=findIndex(header,['surah','surah_no','sura','chapter','chapter_no']);
      const iA=findIndex(header,['ayah','ayah_no','ayah_no_surah','verse','verse_no','aya']);
      const iT=findIndex(header,['english_text','ayah_en','english','translation','text','en']);
      VERSES_EN.clear();
      for(let i=1;i<lines.length;i++){
        const row=splitCSVLine(lines[i]); if(!row || row.length<=Math.max(iS,iA,iT)) continue;
        const k=safeKey(row[iS],row[iA]); if(!k) continue;
        VERSES_EN.set(k,row[iT]||'');
      }
      setStatus(stEN,true,"english");
    }catch(e){
      // English is optional
      setStatus(stEN,false,"english");
    }
  }

  async function ensureShard(mode, surah){
    if (SHARD_CACHE[mode][surah]) return SHARD_CACHE[mode][surah];
    const url = jsonShardUrl(mode, surah);
    const raw = await fetchJSON(url);           // { "1:1":[...], "1:2":[...], meta: {...} }
    const out = {};
    for(const k in raw){
      if(k==="meta") continue;
      out[k] = Array.isArray(raw[k]) ? raw[k] : [];
    }
    SHARD_CACHE[mode][surah] = out;
    if(mode==="hybrid") setStatus(stLH,true,"links (hybrid)");
    if(mode==="cos")    setStatus(stLC,true,"links (cosine)");
    if(mode==="bm25")   setStatus(stLB,true,"links (bm25)");
    return out;
  }

  async function neighborsForKey(mode, key){
    const s = surahOfKey(key);
    const shard = await ensureShard(mode, s);
    const arr = shard[key] || [];
    return arr.slice().map(e=>{
      const id = String(e.id ?? e.key ?? "");
      if(!id || id===key) return null;
      return {
        key:id,
        hybrid: (typeof e.score==='number')? e.score : null,
        cos:    (typeof e.cos==='number')  ? e.cos   : null,
        cos_raw:(typeof e.cos_raw==='number')? e.cos_raw : null,
        bm25:   (typeof e.bm25==='number') ? e.bm25  : null,
        bm25_raw:(typeof e.bm25_raw==='number')? e.bm25_raw : null,
        identical: (e.identical===true),
        reason: e.reason || null,
        overlap: (typeof e.overlap==='number')? e.overlap : null
      };
    }).filter(Boolean).sort((a,b)=>{
      const as=a.hybrid??a.cos??a.bm25??-1, bs=b.hybrid??b.cos??b.bm25??-1;
      return bs - as;
    });
  }

  // ====== SEARCH + RENDER ======
  window.searchByArabic = function(){
    const q = document.getElementById('q_ar').value.trim();
    const nq = normAR(q);
    const keys = (!q?ALL_KEYS:ALL_KEYS.filter(k => normAR(VERSES_AR.get(k)||'').includes(nq))).slice(0,500);
    setResults(keys.map(renderResult).join('') || `<div class='item'>No matches found.</div>`);
  };
  window.searchByEnglish = function(){
    const q = document.getElementById('q_en').value.trim().toLowerCase();
    const keys = (!q?ALL_KEYS:ALL_KEYS.filter(k => (VERSES_EN.get(k)||'').toLowerCase().includes(q))).slice(0,500);
    setResults(keys.map(renderResult).join('') || `<div class='item'>No matches found.</div>`);
  };
  window.searchByID = function(){
    const q = document.getElementById('q_id').value.trim();
    if(!q){ setResults(`<div class='item'>No matches found.</div>`); return; }
    const keys = ALL_KEYS.filter(k => k.includes(q)).slice(0,500);
    if(keys.length){ setResults(keys.map(renderResult).join('')); openNeighbors(keys[0]); }
    else setResults(`<div class='item'>No matches found.</div>`);
  };

  function renderResult(k){
    const ar = VERSES_AR.get(k) || '(Arabic not loaded)';
    const en = VERSES_EN.get(k) || '(English not loaded)';
    return `<div class='item' onclick="openNeighbors('${k}')">
      <div style="display:flex;justify-content:space-between;gap:8px;align-items:center;">
        <div><b class='mono'>${k}</b></div>
      </div>
      <div>${esc(ar)}</div>
      <div class='eng'>${esc(en)}</div>
    </div>`;
  }

  window.openNeighbors = async function(k){
    try{
      setCurrent(k);
      const list = await neighborsForKey(MODE, k);
      window.currentNeighbors = list;
      renderNeighbors(list);
    }catch(e){ showError("Failed to load neighbors: " + e.message); }
  };

  window.renderNeighbors = function(list){
    const filter = document.getElementById('nf').value.trim();
    const minOv = Math.max(0, Math.min(1, Number(document.getElementById('minOv').value || 0)));
    const nqAR = normAR(filter), nqEN = normEN(filter);
    let rows = list || [];
    if(filter){
      rows = rows.filter(x=>{
        const ar = VERSES_AR.get(x.key)||''; const en = VERSES_EN.get(x.key)||'';
        return x.key.includes(filter) || normAR(ar).includes(nqAR) || normEN(en).includes(nqEN) || (x.reason||'').toLowerCase().includes(filter.toLowerCase());
      });
    }
    if(minOv > 0){ rows = rows.filter(x => (Number((x.overlap==null)?0:x.overlap) >= minOv)); }
    setNeighbors(rows.map(renderNeighborRow).join('') || '<div class="item">No neighbors found.</div>');
  };

  function renderNeighborRow(r){
    const ar = VERSES_AR.get(r.key)||''; const en = VERSES_EN.get(r.key)||'';
    const h=r.hybrid, cs=r.cos, csr=r.cos_raw, bm=r.bm25, bmr=r.bm25_raw;
    const showH=(h!=null), showC=(cs!=null), showB=(bm!=null);
    const rank=(h??cs??bm);
    const pct=x=>Math.max(0,Math.min(1,Number(x||0)))*100;
    const badge = r.identical ? `<span class="badge">Identical text</span>` : "";
    const pills=[];
    if(showH) pills.push(`<span class="pill">hybrid: ${h.toFixed(3)}</span>`);
    if(showC) pills.push(`<span class="pill">cos: ${cs.toFixed(3)}${(csr!=null)?` (raw ${csr.toFixed(3)})`:''}</span>`);
    if(showB) pills.push(`<span class="pill">bm25: ${bm.toFixed(3)}${(bmr!=null)?` (raw ${bmr.toFixed(3)})`:''}</span>`);
    if(r.reason) pills.push(`<span class="pill" title="Lexical cue">${esc(r.reason)}</span>`);
    if(r.overlap!=null) pills.push(`<span class="pill">overlap: ${r.overlap.toFixed(2)}</span>`);

    return `<div class='item'>
      <div style="display:flex;justify-content:space-between;gap:8px;align-items:center;">
        <div><b class='mono'>${r.key}</b> ${badge} <span class='muted'>rank: ${rank?.toFixed(3) ?? '—'}</span></div>
      </div>
      <div class="meter" title="hybrid / cosine / bm25">
        ${showH?`<div class="bar-hybrid" style="width:${pct(h)}%"></div>`:''}
      </div>
      <div class="sub" style="display:flex;gap:8px;margin-top:4px;flex-wrap:wrap">
        ${pills.join("")}
      </div>
      <div style="margin-top:6px">${esc(ar)}</div>
      <div class='eng'>${esc(en)}</div>
    </div>`;
  }

  window.clearAll = function(){
    ['q_ar','q_en','q_id','nf'].forEach(id=>{ const el=document.getElementById(id); if(el) el.value=''; });
    setResults(''); setNeighbors(''); setCurrent('—'); clearError();
  };

  // ====== EXPORTS ======
  function downloadText(name, text){
    const a = document.createElement('a');
    a.href = URL.createObjectURL(new Blob([text], {type:'text/plain'}));
    a.download = name; a.click(); URL.revokeObjectURL(a.href);
  }
  document.getElementById('exportJson').addEventListener('click', ()=>{
    const k = elCurrent.textContent.trim(); if(!k || k==='—'){ alert('Open a verse first.'); return; }
    const rows = (window.currentNeighbors||[]).map(r=>({
      id:r.key, hybrid:r.hybrid??"", cos:r.cos??"", cos_raw:r.cos_raw??"",
      bm25:r.bm25??"", bm25_raw:r.bm25_raw??"", identical:!!r.identical,
      overlap:(r.overlap??""), reason:r.reason??""
    }));
    downloadText(`neighbors_${k}.json`, JSON.stringify(rows, null, 2));
  });
  document.getElementById('exportCsv').addEventListener('click', ()=>{
    const k = elCurrent.textContent.trim(); if(!k || k==='—'){ alert('Open a verse first.'); return; }
    const rows = [["id","hybrid","cos","cos_raw","bm25","bm25_raw","overlap","identical","reason"]];
    for(const r of (window.currentNeighbors||[])){
      rows.push([r.key, r.hybrid ?? "", r.cos ?? "", r.cos_raw ?? "", r.bm25 ?? "", r.bm25_raw ?? "", r.overlap ?? "", r.identical ? "true" : "false", (r.reason||"").replace(/"/g,'""')]);
    }
    const csv = rows.map(r=>r.map(x=>`"${x}"`).join(",")).join("\n");
    downloadText(`neighbors_${k}.csv`, csv);
  });

  // ====== BOOT ======
  async function boot(){
    try{
      await loadArabicCSV();
      setStatus(stAR,true,"arabic");
    }catch(e){ showError("Arabic load failed: "+e.message); setStatus(stAR,false,"arabic"); }

    await loadEnglishCSV(); // optional; won't block

    // Pre-warm one shard per mode (if present) so status chips flip to ✓
    try{ await ensureShard("hybrid", 1); }catch(e){ setStatus(stLH,false,"links (hybrid)"); }
    try{ await ensureShard("cos", 1); }catch(e){ setStatus(stLC,false,"links (cosine)"); }
    try{ await ensureShard("bm25", 1); }catch(e){ setStatus(stLB,false,"links (bm25)"); }

    document.getElementById('method').addEventListener('change', e=>{
      MODE = e.target.value;
      if(elCurrent.textContent && elCurrent.textContent!=='—'){ openNeighbors(elCurrent.textContent); }
    });
  }
  boot();

})();
</script>
</body>
</html>
